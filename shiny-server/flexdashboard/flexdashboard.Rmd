---
title: "Knowledge Graphs"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    theme: spacelab 
runtime: shiny
---

```{r}
  devtools::load_all()
  #library(sigmagraph)

  dirpath = system.file('data', package = 'kgraph')
  m_embeds = get(load(file.path(dirpath, 'm_embeds.rds')))
  df_dict = get(load(file.path(dirpath, 'df_dict.rds')))
  df_pairs = get(load(file.path(dirpath, 'df_cuis_pairs.rds')))

  df_dict$desc = df_dict$label
  df_dict$color = df_dict$group_details
  #df_dict$group = df_dict$color

  colors_mapping = get_color_map(unique(df_dict$color))

  react_fit = shiny::reactive({
      fit_kg = fit_embeds_to_pairs(m_embeds, df_pairs, c('umls_id.x', 'umls_id.y'))
      df_projs = fit_kg$df_projs
    })


  react_kgraph = shiny::reactive({
      kgraph = get_kgraph(input$selected_concepts, df_weights, df_dict)
    })



  react_sgraph = shiny::reactive({
      kgraph = react_kgraph()
      sgraph = get_sgraph(kgraph, colors_mapping)
    })

  output$kg = sigmagraph::renderSigmagraph(react_sgraph())
```

# Options {.sidebar}

##

```{r}
  shiny::selectInput('selected_concepts', 'Selected Concepts',
                     sort(unique(df_dict$id)), multiple = TRUE,
                     selected = c('PheCode:300.11', 'PheCode:296.22'))
```

# Graph

##

###

```{r}
  sigmagraph::sigmagraphOutput('kg', height = '100%')
```
